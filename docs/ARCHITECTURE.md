# Arquitetura de Handlers de ComunicaÃ§Ã£o

## ğŸ—ï¸ Diagrama Geral

```
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                   APLICAÃ‡ÃƒO PENDIO                         â•‘
â•‘                                                            â•‘
â•‘  main.cpp (Sensor Logic, State Machine, Business Logic)   â•‘
â•‘                                                            â•‘
â•‘  - Leitura de sensores (AHT, BMP)                          â•‘
â•‘  - MÃ¡quina de estados (NOT_JOINED, READY, WAIT_CFM)       â•‘
â•‘  - Montagem de payloads                                   â•‘
â•‘  - Processamento de downlinks                             â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                          â–²
                          â”‚ Usa
                          â”‚
        â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•©â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
        â”‚                                   â”‚
        â”‚  commHandler->send()              â”‚
        â”‚  commHandler->receive()           â”‚
        â”‚  commHandler->isConnected()       â”‚
        â”‚                                   â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•©â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘         CommunicationHandler (Interface Abstrata)          â•‘
â•‘                                                            â•‘
â•‘  class CommunicationHandler {                              â•‘
â•‘    virtual bool begin() = 0;                               â•‘
â•‘    virtual bool connect() = 0;                             â•‘
â•‘    virtual SendResult send(...) = 0;                       â•‘
â•‘    virtual ReceiveResult receive(...) = 0;                 â•‘
â•‘    virtual bool isConnected() = 0;                         â•‘
â•‘    virtual bool isConfirmed() = 0;                         â•‘
â•‘    virtual ConnectionState getConnectionState() = 0;       â•‘
â•‘    virtual void process() = 0;                             â•‘
â•‘    virtual const char* getStateString() = 0;               â•‘
â•‘  };                                                        â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•¦â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•¦â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                     â”‚                   â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                                          â”‚
        â–¼                                          â–¼
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—                  â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘  LoRaHandler       â•‘                  â•‘  WiFiHandler       â•‘
â•‘                    â•‘                  â•‘                    â•‘
â•‘ ImplementaÃ§Ã£o:     â•‘                  â•‘ Estrutura:         â•‘
â•‘ âœ“ Completa        â•‘                  â•‘ â³ Exemplo         â•‘
â•‘                    â•‘                  â•‘                    â•‘
â•‘ Hardware:          â•‘                  â•‘ Hardware:          â•‘
â•‘ SMW_SX1262M0      â•‘                  â•‘ ESP32 WiFi         â•‘
â•‘                    â•‘                  â•‘                    â•‘
â•‘ Features:          â•‘                  â•‘ Features:          â•‘
â•‘ â€¢ OTAA Join       â•‘                  â•‘ â€¢ SSID Connect    â•‘
â•‘ â€¢ CFM (ACK)       â•‘                  â•‘ â€¢ HTTP POST       â•‘
â•‘ â€¢ ADR             â•‘                  â•‘ â€¢ TCP Direct      â•‘
â•‘ â€¢ DR Fixo         â•‘                  â•‘ â€¢ Headers HTTP    â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•                  â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  MockCommHandler (Testes)                               â”‚
â”‚                                                         â”‚
â”‚  Simula comportamento de handlers reais:                â”‚
â”‚  â€¢ Delays de conexÃ£o/envio                              â”‚
â”‚  â€¢ ConfirmaÃ§Ã£o automÃ¡tica                               â”‚
â”‚  â€¢ InjeÃ§Ã£o de downlinks                                 â”‚
â”‚  â€¢ Erros aleatÃ³rios                                     â”‚
â”‚  â€¢ Contador de mensagens                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ“Š MÃ¡quina de Estados de ConexÃ£o

```
                     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                     â”‚  DISCONNECTED   â”‚
                     â”‚                 â”‚
                     â”‚ Estado inicial  â”‚
                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â”‚ connect()
                              â”‚
                     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
                     â”‚   CONNECTING    â”‚
                     â”‚                 â”‚
                     â”‚ Aguardando JOIN â”‚
                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚                   â”‚
            (timeout)                (sucesso)
            â”‚                         â”‚
            â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
            â”‚    â”‚  ERROR         â”‚   â”‚
            â”‚    â”‚                â”‚â—„â”€â”€â”˜
            â”‚    â”‚ Pode tentar    â”‚
            â”‚    â”‚ reconectar     â”‚
            â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚             â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                          â”‚              â”‚
                    connect() novamente
                          â”‚              â”‚
                     â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
                     â”‚  CONNECTED   â”‚â—„â”€â”€â”€â”˜
                     â”‚              â”‚
                     â”‚  Pronto!     â”‚
                     â””â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                    send()
                       â”‚
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚ WAITING_CFM      â”‚
              â”‚                  â”‚
              â”‚ Aguardando ACK   â”‚
              â”‚ ou timeout       â”‚
              â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”˜
                   â”‚         â”‚
          (ACK)    â”‚         â”‚ (timeout)
                   â”‚         â”‚
              â”Œâ”€â”€â”€â”€â–¼â”€â”€â”  â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â”
              â”‚        â”‚  â”‚        â”‚
              â””â”€â”€â”€â”€â”¬â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”˜
                   â”‚           â”‚
         (volta para CONNECTED)
                   â”‚
```

## ğŸ”„ Fluxo Completo de Envio

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   loop() em main.cpp â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ 1. Ler sensores          â”‚
    â”‚    - AHT (temp, umid)    â”‚
    â”‚    - BMP (pressÃ£o)       â”‚
    â”‚    - RS485 (modbus)      â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ 2. Montar payload        â”‚
    â”‚    CPendio_LoRa_Sensor   â”‚
    â”‚    Data (N bytes)        â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ 3. Verificar estado da conexÃ£o       â”‚
    â”‚    if (handler->isConnected())       â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”
        â”‚             â”‚
       SIM            NÃƒO â†’ tentar connect()
        â”‚
        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. Enviar dados                   â”‚
â”‚  handler->send(port, data, len)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
     â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚                 â”‚
   SUCCESS         FAILED/...
     â”‚                 â”‚
     â–¼                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚Estado WAIT   â”‚  â”‚Estado ERRORâ”‚
â”‚     CFM      â”‚  â”‚Retentativa â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚log erro    â”‚
       â”‚          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
 (apÃ³s ~6s ou ACK recebido)
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 5. Verificar ACK         â”‚
â”‚  handler->isConfirmed()  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
      â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”
      â”‚           â”‚
    TRUE        FALSE
      â”‚           â”‚
      â–¼           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ACK OK   â”‚  â”‚NACK recebido â”‚
â”‚PrÃ³ximo  â”‚  â”‚Erro contador â”‚
â”‚ciclo    â”‚  â”‚Retentativa   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ”€ SeleÃ§Ã£o de Handler

### CompilaÃ§Ã£o Condicional (Recomendado)

```cpp
// platformio.ini ou compiler flags

#ifdef USE_LORA
    LoRaConfig cfg = {...};
    commHandler = new LoRaHandler(cfg);
#elif defined(USE_WIFI)
    WiFiConfig cfg = {...};
    commHandler = new WiFiHandler(cfg);
#elif defined(USE_MOCK)
    MockCommConfig cfg = {...};
    commHandler = new MockCommHandler(cfg);
#else
    #error "Nenhum handler de comunicaÃ§Ã£o selecionado"
#endif

// Resto do cÃ³digo Ã© agnÃ³stico
```

### Factory Pattern (Alternativo)

```cpp
enum CommType { LORA, WIFI, MOCK };

CommunicationHandler* createHandler(CommType type) {
    switch(type) {
        case LORA:
            return new LoRaHandler(loraConfig);
        case WIFI:
            return new WiFiHandler(wifiConfig);
        case MOCK:
            return new MockCommHandler(mockConfig);
    }
}

// No setup()
commHandler = createHandler(CONFIG_COMM_TYPE);
```

## ğŸ“¦ Estrutura de Dados

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  DownlinkMessage                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ uint8_t port (1-223)            â”‚
â”‚ uint8_t data[256]               â”‚
â”‚ uint16_t length                 â”‚
â”‚ uint32_t timestamp              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  LoRaConfig                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ HardwareSerial* serial          â”‚
â”‚ const uint8_t* appEUI (8B)      â”‚
â”‚ const uint8_t* appKey (16B)     â”‚
â”‚ bool useConfirmation            â”‚
â”‚ bool useADR                     â”‚
â”‚ uint8_t fixedDR (0-7)           â”‚
â”‚ unsigned long joinTimeout (ms)  â”‚
â”‚ unsigned long confirmTimeout    â”‚
â”‚ uint8_t maxRetries              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  MockCommConfig                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ unsigned long joinDelay (ms)    â”‚
â”‚ unsigned long sendDelay (ms)    â”‚
â”‚ bool autoConfirm                â”‚
â”‚ bool simulateErrors             â”‚
â”‚ uint8_t errorRate (0-100%)      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  WiFiConfig (quando completo)   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ const char* ssid                â”‚
â”‚ const char* password            â”‚
â”‚ const char* serverAddr          â”‚
â”‚ uint16_t serverPort             â”‚
â”‚ unsigned long connectTimeout    â”‚
â”‚ unsigned long sendTimeout       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ”— DependÃªncias de Classe

```
CommunicationHandler
    â–³
    â”‚ (heranÃ§a)
    â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚              â”‚              â”‚              â”‚
LoRaHandler    WiFiHandler   MockCommHandler
    â”‚
    â”œâ”€ SMW_SX1262M0
    â”œâ”€ HardwareSerial
    â””â”€ Arduino.h

main.cpp
    â”‚
    â”œâ”€ CommunicationHandler*
    â”œâ”€ Sensores.h
    â”œâ”€ HW.h
    â”œâ”€ config.h
    â”œâ”€ credentials.h
    â””â”€ aplic.h
```

## ğŸš€ Fluxo de InicializaÃ§Ã£o

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Arduino setup()â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. iniHW()           â”‚
â”‚    Configura pinos   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. Serial.begin()    â”‚
â”‚    Serial1.begin()   â”‚
â”‚    Serial2.begin()   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. Inicializar sens. â”‚
â”‚    AHT, BMP, RS485   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. handler->begin()            â”‚
â”‚    - Reset mÃ³dulo              â”‚
â”‚    - Carregar configuraÃ§Ã£o     â”‚
â”‚    - Salvar settings           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 5. handler->connect()          â”‚
â”‚    - Enviar JOIN               â”‚
â”‚    - Aguardar (timeout)        â”‚
â”‚    - Estado CONNECTING->CONN.  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Setup concluÃ­do     â”‚
â”‚ Pronto para loop    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ”„ Fluxo do Loop CÃ­clico

```
loop() {
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ handler->process()              â”‚
    â”‚ (atualizar estados, timeouts)   â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ MÃ¡quina de Estados Principal    â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
        â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                                  â”‚
    STATE_NOT_JOINED              STATE_READY
        â”‚                              â”‚
        â–¼                              â–¼
    if (isConn) ?              Ler sensores
        â”‚                      Montar payload
    STATE_READY              handler->send()
                                   â”‚
                          STATE_WAIT_CFM
                                   â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚                             â”‚
              isConfirmed()?            timeout?
                    â”‚                      â”‚
              â”Œâ”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”           â”Œâ”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”
              â”‚           â”‚           â”‚          â”‚
             YES         NO        Retry    Max retries?
              â”‚           â”‚           â”‚         â”‚
              â–¼           â–¼           â–¼         â–¼
         STATE_READY  (erro)    STATE_WAIT  STATE_READY
              â”‚                  CFM      (erro)
              â”‚
         receive() downlink
              â”‚
         processar dados
              â”‚
              â–¼
         loop() continua
}
```

## ğŸ¯ Matriz de Compatibilidade

| Feature | LoRa | WiFi | Mock |
|---------|------|------|------|
| begin() | âœ… | â³ | âœ… |
| connect() | âœ… | â³ | âœ… |
| send() | âœ… | â³ | âœ… |
| isConfirmed() | âœ… | â³ | âœ… |
| receive() | âœ… | â³ | âœ… |
| process() | âœ… | â³ | âœ… |
| getConnectionState() | âœ… | â³ | âœ… |
| getStateString() | âœ… | â³ | âœ… |

**Status**: âœ… Implementado | â³ Em desenvolvimento

## ğŸ“ˆ Escalabilidade

Para cada novo handler (ex: 4G, LoRaWAN-MQTT):

```
1. Criar: include/NewHandler.h
2. Criar: src/NewHandler.cpp
3. Herdar: class NewHandler : public CommunicationHandler
4. Implementar: 9 mÃ©todos virtuais
5. Usar: CommunicationHandler* h = new NewHandler(cfg);
```

---
